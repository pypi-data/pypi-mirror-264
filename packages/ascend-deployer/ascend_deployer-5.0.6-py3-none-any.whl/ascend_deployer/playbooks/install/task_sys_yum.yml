- name: check index status
  shell: |
    timeout=0
    while true;do
        if [ $(docker logs nexus | grep 'Finished .* {{os_and_arch}}' | wc -l) -eq 1 ];then
            break
        else
            sleep 1
            ((++timeout))
            if [ $timeout -eq 120 ];then
                echo "install sys_pkgs failed" && exit 1
            fi
        fi
    done
  delegate_to: localhost

- name: install kernel headers devel
  include_tasks: task_kernel.yml
  when: "'EulerOS' in os_and_arch"

- name: install kernel headers devel force for euler
  include_tasks: task_kernel_euleros.yml
  when: "'EulerOS' in os_and_arch"

- name: yum install system packages
  shell: |
    sed -i 's/enabled=1/enabled=0/' /etc/dnf/plugins/license-manager.conf 2>/dev/null||true && \
    yum clean all &>/dev/null && \
    yum makecache --disablerepo="*" --enablerepo=nexus -c ~/nexus/sources.repo &>/dev/null && \
    yum install --skip-broken -y {{sys_pkgs}} --disablerepo="*" --enablerepo=nexus -c ~/nexus/sources.repo && \
    sed -i 's/enabled=0/enabled=1/' /etc/dnf/plugins/license-manager.conf 2>/dev/null||true
  register: sys_result
  environment:
    LD_LIBRARY_PATH: ""
    http_proxy: ""
    https_proxy: ""
    HTTP_PROXY: ""
    HTTPS_PROXY: ""
  when:
    - "'CentOS_7.6' not in os_and_arch"

- name: yum install system packages
  shell: |
    yum clean all &>/dev/null
    yum makecache --disablerepo="*" --enablerepo=nexus -c ~/nexus/sources.repo &>/dev/null
    yum install --skip-broken -y {{sys_pkgs}} --disablerepo="*" --enablerepo=nexus -c ~/nexus/sources.repo
  register: sys_result
  environment:
    LD_LIBRARY_PATH: ""
    http_proxy: ""
    https_proxy: ""
    HTTP_PROXY: ""
    HTTPS_PROXY: ""
  when:
    - "'CentOS_7.6' in os_and_arch"
  failed_when: false

- name: message
  debug: var=sys_result

- name: install kernel for centos 7
  shell: |
    rpm -ivh --force --nodeps --replacepkgs {{ resources_dir }}/{{ os_and_arch }}/kernel*4.14*.rpm
  when:
    - "'CentOS_7.6' in os_and_arch"
    - "'aarch64' in os_and_arch"

- name: install kernel for centos 7
  shell: |
    rpm -ivh --force --nodeps --replacepkgs {{ resources_dir }}/{{ os_and_arch }}/kernel*3.10.0-957*.rpm
  when:
    - "'CentOS_7.6' in os_and_arch"
    - "'86' in os_and_arch"

- name: check if Docker is installed
  shell: command -v docker | wc -l
  register: docker_status

- name: install Docker when Docker is not installed
  shell: |
    yum install -y --skip-broken {{docker_pkgs}} --disablerepo="*" --enablerepo=nexus -c ~/nexus/sources.repo
  register: docker_result
  environment:
    LD_LIBRARY_PATH: ""
    http_proxy: ""
    https_proxy: ""
    HTTP_PROXY: ""
    HTTPS_PROXY: ""
  when:
    - "'CentOS_7.6' not in os_and_arch"
    - docker_status.stdout == "0"

- name: install Docker when Docker is not installed
  shell: |
    rpm -ivh --force --nodeps --replacepkgs {{ resources_dir }}/{{ os_and_arch }}/docker/*.rpm
  register: docker_result
  when:
    - "'CentOS_7.6' in os_and_arch"
    - docker_status.stdout == "0"

- name: message
  debug: var=docker_result
  when:
    - docker_result.changed
