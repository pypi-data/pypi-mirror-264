- name: find tfplugin patch package
  find:
    paths: "{{ cann_dirs }}"
    recurse: no
    file_type: file
    use_regex: yes
    patterns: ".*tfplugin.*{{ansible_architecture}}.run"
  register: tfplugin

- name: rollback tfplugin
  shell: "bash {{ tfplugin.files[0].path }} --rollback"
  register: tfplugin_result
  when: tfplugin.matched > 0

- name: message
  debug:
    msg:
      - "[ASCEND]can not find tfplugin patch package,tfplugin rollback skipped"
  when: tfplugin.matched == 0

- name: fail if this rollback
  fail:
    msg: "[ASCEND]failed to rollback tfplugin"
  when: "'tfplugin' in ansible_run_tags and tfplugin.matched == 0"

- name: message
  debug:
    var: tfplugin_result
  when: tfplugin_result.changed