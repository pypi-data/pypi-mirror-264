stages:
  - build
  - test
  - publish

build-theme:
  image: node:20
  stage: build
  script:
    - npm install
    - npm run build
  artifacts:
    paths:
      - ou_book_theme
    expire_in: 300 seconds
  interruptible: true

build-package:
  image: python:3.11
  stage: build
  script:
    - pip install hatch
    - hatch build
  dependencies:
    - build-theme
  needs:
    - build-theme
  artifacts:
    paths:
      - dist
    expire_in: 300 seconds
  interruptible: true

build-docs:
  image: python:3.11
  stage: build
  script:
    - pip install hatch
    - hatch run jupyter-book build docs --all
    - cd docs/_build
    - tar -jcf docs.tar.bz2 html
  dependencies:
    - build-theme
  needs:
    - build-theme
  artifacts:
    paths:
      - docs/_build
    expire_in: 300 seconds
  interruptible: true

run-tests:
  image: python:3.11
  stage: test
  script:
    - pip install hatch
    - hatch run cov
  dependencies:
    - build-theme
  interruptible: true

run-lint:
  image: python:3.11
  stage: test
  script:
    - pip install hatch
    - hatch run lint:ruff ou_book_theme
  interruptible: true

publish-package:
  image: python:3.11
  stage: publish
  script:
    - pip install hatch
    - hatch publish --user __token__ --auth $PYPI_AUTH_TOKEN
  dependencies:
    - build-package
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+(b[0-9]+)?$/

publish-docs:
  image: quay.io/curl/curl:latest
  stage: publish
  script:
    - export MAJOR_VERSION=`echo ${CI_COMMIT_TAG} | cut -d "." -f1`
    - cd docs/_build
    - 'curl -X PUT -H "Authorization: Bearer $DOCS_TOKEN" -F "archive=@docs.tar.bz2" https://docs-api.ocl.open.ac.uk/upload/ou-book-theme/$MAJOR_VERSION'
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+(b[0-9]+)?$/
